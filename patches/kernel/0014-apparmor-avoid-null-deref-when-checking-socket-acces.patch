From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fabian=20Gr=C3=BCnbichler?= <f.gruenbichler@proxmox.com>
Date: Wed, 26 Nov 2025 13:29:02 +0100
Subject: [PATCH] apparmor: avoid null-deref when checking socket access
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

a socket might not yet have valid private data associated with it, avoid
assuming it has, otherwise the access might trigger a NULL deref.

Reported-by: Jamin Mc <jaminmc@gmail.com>
Closes: https://bugzilla.proxmox.com/show_bug.cgi?id=7083
Closes: https://gitlab.com/apparmor/apparmor/-/issues/568

Signed-off-by: Fabian Gr√ºnbichler <f.gruenbichler@proxmox.com>
---
 security/apparmor/file.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/security/apparmor/file.c b/security/apparmor/file.c
index d30be1979cedb6ead269e342e5b656124e82317f..1405682c21da7f5d66db232e3c3fc0ac190d2c63 100644
--- a/security/apparmor/file.c
+++ b/security/apparmor/file.c
@@ -777,7 +777,7 @@ static bool __unix_needs_revalidation(struct file *file, struct aa_label *label,
 		return false;
 	if (request & NET_PEER_MASK)
 		return false;
-	if (sock->sk->sk_family == PF_UNIX) {
+	if (sock && sock->sk && sock->sk->sk_family == PF_UNIX) {
 		struct aa_sk_ctx *ctx = aa_sock(sock->sk);
 
 		if (rcu_access_pointer(ctx->peer) !=
